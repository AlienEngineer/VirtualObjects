<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>Virtual Objects by AlienEngineer</title>
    <link rel="stylesheet" href="stylesheets/styles.css">
    <link rel="stylesheet" href="stylesheets/pygment_trac.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
    <script src="javascripts/respond.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <!--[if lt IE 8]>
    <link rel="stylesheet" href="stylesheets/ie.css">
    <![endif]-->
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

  </head>
  <body>
      <div id="header">
        <nav>
          <li class="fork"><a href="https://github.com/AlienEngineer/VirtualObjects">View On GitHub</a></li>
          <li class="downloads"><a href="https://github.com/AlienEngineer/VirtualObjects/zipball/master">ZIP</a></li>
          <li class="downloads"><a href="https://github.com/AlienEngineer/VirtualObjects/tarball/master">TAR</a></li>
          <li class="title">DOWNLOADS</li>
        </nav>
      </div><!-- end header -->

    <div class="wrapper">

      <section>
        <div id="title">
          <h1>Virtual Objects</h1>
          <p>Virtual Objects</p>
          <hr>
          <span class="credits left">Project maintained by <a href="https://github.com/AlienEngineer">AlienEngineer</a></span>
          <span class="credits right">Hosted on GitHub Pages &mdash; Theme by <a href="https://twitter.com/michigangraham">mattgraham</a></span>
        </div>

        <h3>
<a name="menu" class="anchor" href="#menu"><span class="octicon octicon-link"></span></a>Menu</h3>

<ul>
<li><a href="#getting-started">Getting Started</a></li>
<li><a href="#poco-classes-plain-old-clr-object">POCO Classes</a></li>
<li><a href="#crud-operations">Crud Operations</a></li>
<li><a href="#linq-support">Linq Support</a></li>
<li><a href="#data-type-mappings">Data Type Mappings</a></li>
<li><a href="#support-or-contact">Support or Contact</a></li>
</ul><hr><h3>
<a name="getting-started" class="anchor" href="#getting-started"><span class="octicon octicon-link"></span></a>Getting Started</h3>

<h4>
<a name="create-a-model" class="anchor" href="#create-a-model"><span class="octicon octicon-link"></span></a>Create a Model</h4>

<div class="highlight highlight-C#"><pre><span class="k">public</span> <span class="k">class</span> <span class="nc">Employee</span> 
<span class="p">{</span>
    <span class="k">public</span> <span class="n">String</span> <span class="n">EmployeeId</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">public</span> <span class="n">String</span> <span class="n">LastName</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="c1">// Other fields ...</span>
<span class="p">}</span>
</pre></div>

<h4>
<a name="config-the-connection" class="anchor" href="#config-the-connection"><span class="octicon octicon-link"></span></a>Config the Connection</h4>

<div class="highlight highlight-XML"><pre>  <span class="nt">&lt;connectionStrings&gt;</span>
    <span class="nt">&lt;clear/&gt;</span>
    <span class="nt">&lt;add</span> <span class="na">name=</span><span class="s">"YourMachineName"</span> 
         <span class="na">providerName=</span><span class="s">"System.Data.SqlClient"</span> 
         <span class="na">connectionString=</span><span class="s">"</span>
<span class="s">               Data Source=.\instance;</span>
<span class="s">               Initial Catalog=db;</span>
<span class="s">               Integrated Security=true"</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;/connectionStrings&gt;</span>
</pre></div>

<h4>
<a name="use-it" class="anchor" href="#use-it"><span class="octicon octicon-link"></span></a>Use it!</h4>

<div class="highlight highlight-C#"><pre>   <span class="k">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">session</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Session</span><span class="p">())</span>
   <span class="p">{</span>
      <span class="n">IQueryable</span><span class="p">&lt;</span><span class="n">Employee</span><span class="p">&gt;</span> <span class="n">employees</span> <span class="p">=</span> <span class="n">session</span><span class="p">.</span><span class="n">GetAll</span><span class="p">&lt;</span><span class="n">Employee</span><span class="p">&gt;()</span>
        <span class="p">.</span><span class="n">Where</span><span class="p">(</span><span class="n">e</span> <span class="p">=&gt;</span> <span class="n">e</span><span class="p">.</span><span class="n">BirthDate</span><span class="p">.</span><span class="n">Year</span> <span class="p">&gt;</span> <span class="m">1983</span><span class="p">);</span>

      <span class="n">session</span><span class="p">.</span><span class="n">Insert</span><span class="p">(</span><span class="k">new</span> <span class="n">Employee</span> 
      <span class="p">{</span>
         <span class="n">Name</span> <span class="p">=</span> <span class="s">"I'm the new guy!"</span>
      <span class="p">});</span>
   <span class="p">}</span>
</pre></div>

<hr><h3>
<a name="poco-classes-plain-old-clr-object" class="anchor" href="#poco-classes-plain-old-clr-object"><span class="octicon octicon-link"></span></a>POCO classes (Plain Old CLR Object)</h3>

<p>There's no need to derive our model types from any specific type. But they can...
Our POCO classes should be defined with properties with R/W (get/set). </p>

<div class="highlight highlight-C#"><pre><span class="k">public</span> <span class="kt">int</span> <span class="n">EmployeeId</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
<span class="k">public</span> <span class="n">String</span> <span class="n">LastName</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
<span class="k">public</span> <span class="n">String</span> <span class="n">FirstName</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
<span class="c1">//...</span>
</pre></div>

<p>In case we want lazy load of a foreign reference the property should be marked as Virtual (to enable interception). This is not a requirement, use it if you would like the ORM to load your references for you.</p>

<div class="highlight highlight-C#"><pre><span class="k">public</span> <span class="k">virtual</span> <span class="n">Employee</span> <span class="n">ReportsTo</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</pre></div>

<p>To map with the data source fields attributes can be used to add metadata to our poco classes. This is not a requirement.</p>

<p>This is fully configurable. To configure the way pocos are mapped, you must derive the type SessionConfiguration and override the method ConfigureMappingBuilder(IMappingBuilder builder). The final stage is to give the custom configuration to the Session. See above.</p>

<p>This configuration can be made so our pocos will be totally compatible with EntityFramework or other ORM frameworks/libraries. </p>

<div class="highlight highlight-C#"><pre><span class="k">class</span> <span class="nc">Configuration</span> <span class="p">:</span> <span class="n">SessionConfiguration</span>
<span class="p">{</span>    
    <span class="k">public</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">ConfigureMappingBuilder</span><span class="p">(</span><span class="n">IMappingBuilder</span> <span class="n">builder</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">//</span>
        <span class="c1">// TableName getters</span>
        <span class="c1">//</span>
        <span class="n">builder</span><span class="p">.</span><span class="n">EntityNameFromType</span><span class="p">(</span><span class="n">e</span> <span class="p">=&gt;</span> <span class="n">e</span><span class="p">.</span><span class="n">Name</span><span class="p">);</span>
        <span class="n">builder</span><span class="p">.</span><span class="n">EntityNameFromAttribute</span><span class="p">&lt;</span><span class="n">TableAttribute</span><span class="p">&gt;(</span><span class="n">e</span> <span class="p">=&gt;</span> <span class="n">e</span><span class="p">.</span><span class="n">TableName</span><span class="p">);</span>

        <span class="c1">//</span>
        <span class="c1">// ColumnName getters</span>
        <span class="c1">//</span>
        <span class="n">builder</span><span class="p">.</span><span class="n">ColumnNameFromProperty</span><span class="p">(</span><span class="n">e</span> <span class="p">=&gt;</span> <span class="n">e</span><span class="p">.</span><span class="n">Name</span><span class="p">);</span>
        <span class="n">builder</span><span class="p">.</span><span class="n">ColumnNameFromAttribute</span><span class="p">&lt;</span><span class="n">ColumnAttribute</span><span class="p">&gt;(</span><span class="n">e</span> <span class="p">=&gt;</span> <span class="n">e</span><span class="p">.</span><span class="n">FieldName</span><span class="p">);</span>

        <span class="c1">// (e.g.) A key is a property that ends with 'Id'</span>
        <span class="c1">// builder.ColumnKeyFromProperty(e =&gt; e.Name.EndsWith("Id"));</span>
        <span class="c1">//</span>
        <span class="n">builder</span><span class="p">.</span><span class="n">ColumnKeyFromAttribute</span><span class="p">&lt;</span><span class="n">KeyAttribute</span><span class="p">&gt;();</span>
        <span class="n">builder</span><span class="p">.</span><span class="n">ColumnKeyFromAttribute</span><span class="p">&lt;</span><span class="n">IdentityAttribute</span><span class="p">&gt;();</span>

        <span class="n">builder</span><span class="p">.</span><span class="n">ColumnIdentityFromAttribute</span><span class="p">&lt;</span><span class="n">IdentityAttribute</span><span class="p">&gt;();</span>

        <span class="n">builder</span><span class="p">.</span><span class="n">ForeignKeyFromAttribute</span><span class="p">&lt;</span><span class="n">AssociationAttribute</span><span class="p">&gt;(</span><span class="n">e</span> <span class="p">=&gt;</span> <span class="n">e</span><span class="p">.</span><span class="n">OtherKey</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>

<div class="highlight highlight-C#"><pre><span class="n">using</span><span class="p">(</span><span class="kt">var</span> <span class="n">session</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Session</span><span class="p">(</span><span class="k">new</span> <span class="n">Configuration</span><span class="p">())</span>
<span class="p">{</span>
   <span class="c1">// Use the session with your custom configuration.</span>
<span class="p">}</span>
</pre></div>

<hr><h3>
<a name="crud-operations" class="anchor" href="#crud-operations"><span class="octicon octicon-link"></span></a>Crud Operations</h3>

<div class="highlight highlight-C#"><pre>   <span class="c1">// Create</span>
   <span class="n">Employee</span> <span class="n">Sergio</span> <span class="p">=</span> <span class="n">session</span><span class="p">.</span><span class="n">Insert</span><span class="p">(</span><span class="k">new</span> <span class="n">Employee</span> 
   <span class="p">{</span>
      <span class="n">FirstName</span> <span class="p">=</span> <span class="s">"Sérgio"</span><span class="p">,</span>
      <span class="n">LastName</span> <span class="p">=</span> <span class="s">"Ferreira"</span><span class="p">,</span>
      <span class="n">BirthDate</span> <span class="p">=</span> <span class="k">new</span> <span class="n">DateTime</span><span class="p">(</span><span class="m">1983</span><span class="p">,</span> <span class="m">4</span><span class="p">,</span> <span class="m">16</span><span class="p">)</span>
   <span class="p">});</span>   

   <span class="c1">// Read</span>
   <span class="n">Employee</span> <span class="n">employee</span> <span class="p">=</span> <span class="n">session</span><span class="p">.</span><span class="n">GetById</span><span class="p">(</span><span class="n">Employee</span> <span class="p">{</span> <span class="n">EmployeeId</span> <span class="p">=</span> <span class="m">1</span> <span class="p">});</span>

   <span class="c1">// Update</span>
   <span class="n">session</span><span class="p">.</span><span class="n">Update</span><span class="p">(</span><span class="n">employee</span><span class="p">);</span>

   <span class="c1">// Delete</span>
   <span class="n">session</span><span class="p">.</span><span class="n">Delete</span><span class="p">(</span><span class="n">employee</span><span class="p">);</span>
</pre></div>

<hr><h3>
<a name="linq-support" class="anchor" href="#linq-support"><span class="octicon octicon-link"></span></a>Linq Support</h3>

<div class="highlight highlight-C#"><pre>    <span class="n">IQueryable</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">query</span> <span class="p">=</span> <span class="n">Session</span><span class="p">.</span><span class="n">GetAll</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;();</span>
    <span class="c1">// Or</span>
    <span class="n">IQueryable</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">query</span> <span class="p">=</span> <span class="n">Session</span><span class="p">.</span><span class="n">Query</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;();</span>
</pre></div>

<p>All queries can be verified under "VirtualObjects.Tests.Queries" namespace.</p>

<p>Just to be clear, all Linq queries are translated into the proper SQL parameterized commands. The framework will only load what needed to be loaded from the data source.</p>

<p>To see what SQL is being generated just give the session a configuration instance that set the Logger to Console.Out for debug purposes. In release versions your app should never have the logger setted. This could result in pour performance.</p>

<h4>
<a name="iqueryable-methods-supported" class="anchor" href="#iqueryable-methods-supported"><span class="octicon octicon-link"></span></a>IQueryable Methods Supported</h4>

<ul>
<li>Where</li>
<li>First, FirstOrDefault, Single, SingleOrDefault, Last, LastOrDefault</li>
<li>Count, LongCount</li>
<li>Distinct</li>
<li>GroupBy</li>
<li>Sum, Min, Max, Average</li>
<li>Any</li>
<li>Contains</li>
<li>Join and GroupJoin</li>
<li>Union</li>
<li>Select</li>
<li>OrderBy, OrderByDescending and ThenBy</li>
<li>Take and Skip</li>
</ul><h4>
<a name="supported-projections" class="anchor" href="#supported-projections"><span class="octicon octicon-link"></span></a>Supported Projections</h4>

<div class="highlight highlight-C#"><pre>    <span class="c1">// On group joins (full entities and collection load)</span>
    <span class="k">from</span> <span class="n">o</span> <span class="k">in</span> <span class="n">Query</span><span class="p">&lt;</span><span class="n">Orders</span><span class="p">&gt;()</span>
    <span class="k">join</span> <span class="n">od</span> <span class="k">in</span> <span class="n">Query</span><span class="p">&lt;</span><span class="n">OrderDetails</span><span class="p">&gt;()</span> <span class="n">on</span> <span class="n">o</span> <span class="k">equals</span> <span class="n">od</span><span class="p">.</span><span class="n">Order</span> <span class="k">into</span> <span class="n">ods</span>
    <span class="k">select</span> <span class="k">new</span> <span class="p">{</span> <span class="n">Order</span> <span class="p">=</span> <span class="n">o</span><span class="p">,</span> <span class="n">Details</span> <span class="p">=</span> <span class="n">ods</span> <span class="p">}</span>

    <span class="c1">// On Joins (full entities load)</span>
    <span class="k">from</span> <span class="n">o</span> <span class="k">in</span> <span class="n">Query</span><span class="p">&lt;</span><span class="n">Orders</span><span class="p">&gt;()</span>
    <span class="k">join</span> <span class="n">od</span> <span class="k">in</span> <span class="n">Query</span><span class="p">&lt;</span><span class="n">OrderDetails</span><span class="p">&gt;()</span> <span class="n">on</span> <span class="n">o</span> <span class="k">equals</span> <span class="n">od</span><span class="p">.</span><span class="n">Order</span>
    <span class="k">join</span> <span class="n">e</span> <span class="k">in</span> <span class="n">Query</span><span class="p">&lt;</span><span class="n">Employee</span><span class="p">&gt;()</span> <span class="n">on</span> <span class="n">o</span><span class="p">.</span><span class="n">Employee</span> <span class="k">equals</span> <span class="n">e</span>
    <span class="k">select</span> <span class="k">new</span> <span class="p">{</span> <span class="n">Order</span> <span class="p">=</span> <span class="n">o</span><span class="p">,</span> <span class="n">Detail</span> <span class="p">=</span> <span class="n">od</span><span class="p">,</span> <span class="n">Employee</span> <span class="p">=</span> <span class="n">e</span> <span class="p">}</span>

    <span class="c1">// Specific members projection</span>
    <span class="k">from</span> <span class="n">o</span> <span class="k">in</span> <span class="n">Query</span><span class="p">&lt;</span><span class="n">Orders</span><span class="p">&gt;()</span>
    <span class="k">join</span> <span class="n">od</span> <span class="k">in</span> <span class="n">Query</span><span class="p">&lt;</span><span class="n">OrderDetails</span><span class="p">&gt;()</span> <span class="n">on</span> <span class="n">o</span><span class="p">.</span><span class="n">Freight</span> <span class="k">equals</span> <span class="n">od</span><span class="p">.</span><span class="n">UnitPrice</span>
    <span class="k">select</span> <span class="k">new</span> <span class="p">{</span> <span class="n">o</span><span class="p">.</span><span class="n">OrderId</span><span class="p">,</span> <span class="n">od</span><span class="p">.</span><span class="n">UnitPrice</span><span class="p">,</span> <span class="n">o</span><span class="p">.</span><span class="n">ShipCity</span> <span class="p">}</span>

    <span class="n">Query</span><span class="p">&lt;</span><span class="n">Employee</span><span class="p">&gt;().</span><span class="n">Select</span><span class="p">(</span><span class="n">e</span> <span class="p">=&gt;</span> <span class="k">new</span> <span class="p">{</span> <span class="n">e</span><span class="p">.</span><span class="n">EmployeeId</span><span class="p">,</span> <span class="n">e</span><span class="p">.</span><span class="n">LastName</span><span class="p">,</span> <span class="n">e</span><span class="p">.</span><span class="n">FirstName</span> <span class="p">})</span>

    <span class="c1">// Agregated Projection</span>
    <span class="n">Query</span><span class="p">&lt;</span><span class="n">Employee</span><span class="p">&gt;().</span><span class="n">GroupBy</span><span class="p">(</span><span class="n">e</span> <span class="p">=&gt;</span> <span class="n">e</span><span class="p">.</span><span class="n">City</span><span class="p">)</span>
    <span class="p">.</span><span class="n">Select</span><span class="p">(</span><span class="n">e</span> <span class="p">=&gt;</span> <span class="k">new</span>
    <span class="p">{</span>
        <span class="n">City</span> <span class="p">=</span> <span class="n">e</span><span class="p">.</span><span class="n">Key</span><span class="p">,</span> 
        <span class="n">Min</span> <span class="p">=</span> <span class="n">e</span><span class="p">.</span><span class="n">Min</span><span class="p">(</span><span class="n">o</span> <span class="p">=&gt;</span> <span class="n">o</span><span class="p">.</span><span class="n">EmployeeId</span><span class="p">),</span>
        <span class="n">Max</span> <span class="p">=</span> <span class="n">e</span><span class="p">.</span><span class="n">Max</span><span class="p">(</span><span class="n">o</span> <span class="p">=&gt;</span> <span class="n">o</span><span class="p">.</span><span class="n">EmployeeId</span><span class="p">),</span>
        <span class="n">Sum</span> <span class="p">=</span> <span class="n">e</span><span class="p">.</span><span class="n">Sum</span><span class="p">(</span><span class="n">o</span> <span class="p">=&gt;</span> <span class="n">o</span><span class="p">.</span><span class="n">EmployeeId</span><span class="p">),</span>
        <span class="n">Count</span> <span class="p">=</span> <span class="n">e</span><span class="p">.</span><span class="n">Count</span><span class="p">(),</span>
        <span class="n">Average</span> <span class="p">=</span> <span class="n">e</span><span class="p">.</span><span class="n">Average</span><span class="p">(</span><span class="n">o</span> <span class="p">=&gt;</span> <span class="n">o</span><span class="p">.</span><span class="n">EmployeeId</span><span class="p">)</span>
    <span class="p">})</span>

    <span class="c1">// Calculated Projection</span>
    <span class="n">Query</span><span class="p">&lt;</span><span class="n">Employee</span><span class="p">&gt;().</span><span class="n">GroupBy</span><span class="p">(</span><span class="n">e</span> <span class="p">=&gt;</span> <span class="n">e</span><span class="p">.</span><span class="n">City</span><span class="p">)</span>
    <span class="p">.</span><span class="n">Select</span><span class="p">(</span><span class="n">e</span> <span class="p">=&gt;</span> <span class="k">new</span>
    <span class="p">{</span>
        <span class="n">Average</span> <span class="p">=</span> <span class="n">e</span><span class="p">.</span><span class="n">Sum</span><span class="p">(</span><span class="n">o</span> <span class="p">=&gt;</span> <span class="n">o</span><span class="p">.</span><span class="n">EmployeeId</span><span class="p">)</span> <span class="p">/</span> <span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">Count</span><span class="p">()*</span><span class="m">1.0</span><span class="p">)</span> <span class="p">*</span> <span class="m">100.0</span>
    <span class="p">})</span>

</pre></div>

<h4>
<a name="supported-predicates" class="anchor" href="#supported-predicates"><span class="octicon octicon-link"></span></a>Supported Predicates</h4>

<hr><h3>
<a name="data-type-mappings" class="anchor" href="#data-type-mappings"><span class="octicon octicon-link"></span></a>Data Type Mappings</h3>

<p>Checkout the microsoft table at <a href="http://msdn.microsoft.com/en-us/library/cc716729.aspx">ADO.Net</a></p>

<hr><h3>
<a name="support-or-contact" class="anchor" href="#support-or-contact"><span class="octicon octicon-link"></span></a>Support or Contact</h3>

<p>If you have any suggestions for this project or something is not working right please contact me at <a href="mailto:Alien.Software.Engineer@gmail.com">Alien.Software.Engineer@gmail.com</a> or <a href="https://github.com/AlienEngineer" class="user-mention">@AlienEngineer</a> (github)</p>

<h3>
<a name="for-more-info-click-here" class="anchor" href="#for-more-info-click-here"><span class="octicon octicon-link"></span></a>For more info click <a href="http://alienengineer.github.com/VirtualObjects/">here</a>
</h3>

<h3>
<a name="get-it-as-a-nuget-package-here" class="anchor" href="#get-it-as-a-nuget-package-here"><span class="octicon octicon-link"></span></a>Get it as a NuGet Package <a href="http://www.nuget.org/packages/VirtualObjects/">here</a>
</h3>

<pre><code>   PM&gt; Install-Package VirtualObjects -Pre
</code></pre>

<h3>
<a name="dependencies" class="anchor" href="#dependencies"><span class="octicon octicon-link"></span></a>Dependencies</h3>

<ul>
<li>Castle.Core       (≥ 3.2.2)</li>
<li>fasterflect       (≥ 2.1.3)</li>
<li>Ninject           (≥ 3.0.1.10)</li>
</ul>
      </section>

    </div>
    <!--[if !IE]><script>fixScale(document);</script><![endif]-->
    
  </body>
</html>